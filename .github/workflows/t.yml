name: Process MDN Content with Gemini API

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  process-content:
    runs-on: ubuntu-latest

    steps:
      # Step 0: Checkout original repository
      - name: Checkout original repository
        uses: actions/checkout@v4
        with:
          path: original-repo

      # Step 1: Checkout mdn/content repository
      - name: Checkout mdn/content
        uses: actions/checkout@v4
        with:
          repository: mdn/content
          path: mdn-content

      # Step 2: Read p1.md and p2.md from original repository
      - name: Read p1 and p2 content
        id: get-content
        run: |
          # 檢查檔案是否存在
          if [ -f original-repo/p1.md ]; then
            p1_content=$(cat original-repo/p1.md)
          else
            p1_content=""
          fi

          if [ -f original-repo/p2.md ]; then
            p2_content=$(cat original-repo/p2.md)
          else
            p2_content=""
          fi

          # Escape newlines for GitHub output
          echo "p1=$(jq -Rs <<< "$p1_content")" >> $GITHUB_OUTPUT
          echo "p2=$(jq -Rs <<< "$p2_content")" >> $GITHUB_OUTPUT

      # Step 3: Read and process README paths from original repo
      - name: Read and process README paths
        id: get-paths
        run: |
          if [ ! -f original-repo/README.md ]; then
            echo "Error: README.md not found in original repository"
            exit 1
          fi
          paths=$(sed 's|$|/index.md|' original-repo/README.md | tr '\n' ' ')
          echo "paths=$paths" >> $GITHUB_OUTPUT

      # Step 4: Process with Gemini API and save results in original repo
      - name: Process with Gemini API
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          IFS=' ' read -r -a path_array <<< "${{ steps.get-paths.outputs.paths }}"
          p1=$(jq -r . <<< "${{ steps.get-content.outputs.p1 }}")
          p2=$(jq -r . <<< "${{ steps.get-content.outputs.p2 }}")

          for path in "${path_array[@]}"; do
            content=""
            mdn_path="mdn-content/$path"

            # 檢查 mdn-content 是否有對應檔案
            if [ -f "$mdn_path" ]; then
              content=$(jq -Rs < "$mdn_path")
            fi

            # 呼叫 Gemini API
            response=$(curl -s -X POST "https://api.gemini.com/v1/process" \
              -H "Authorization: Bearer $GEMINI_API_KEY" \
              -H "Content-Type: application/json" \
              -d "{\"input\": \"$p1$content$p2\"}")

            # 建立目錄並儲存回應
            mkdir -p "original-repo/$(dirname "$path")"
            echo "$response" > "original-repo/$path"

            sleep 2
          done

      # Step 5: Commit and push results to original repository
      - name: Commit results
        run: |
          cd original-repo
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add .
          git commit -m "Update processed content" || echo "No changes to commit"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}