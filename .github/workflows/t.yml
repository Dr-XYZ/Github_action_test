name: Process MDN Content with Gemini API

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  process-content:
    runs-on: ubuntu-latest
    
    steps:
      # Step 0: Checkout mdn/content repository
      - name: Checkout mdn/content
        uses: actions/checkout@v3
        with:
          repository: mdn/content
          path: mdn-content

      # Step 1: Checkout this repository and read README.md
      - name: Checkout this repository
        uses: actions/checkout@v3
        with:
          path: this-repo

      - name: Read and process README paths
        id: get-paths
        run: |
          # Read README.md and process paths
          paths=$(cat this-repo/README.md | sed 's|$|/index.md|' | tr '\n' ' ')
          echo "paths=$paths" >> $GITHUB_OUTPUT
        working-directory: this-repo

      # Step 2: Read p1.md and p2.md
      - name: Read p1 and p2 content
        id: get-content
        run: |
          p1_content=$(cat this-repo/p1.md)
          p2_content=$(cat this-repo/p2.md)
          # Escape newlines for GitHub output
          echo "p1=$(echo "$p1_content" | tr '\n' '\\n')" >> $GITHUB_OUTPUT
          echo "p2=$(echo "$p2_content" | tr '\n' '\\n')" >> $GITHUB_OUTPUT
        working-directory: this-repo

      # Step 3 & 4: Process each path with Gemini API and save results
      - name: Process with Gemini API
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          IFS=' ' read -r -a path_array <<< "${{ steps.get-paths.outputs.paths }}"
          p1="${{ steps.get-content.outputs.p1 }}"
          p2="${{ steps.get-content.outputs.p2 }}"
          
          for path in "${path_array[@]}"; do
            # Read content from mdn-content
            content=$(cat "mdn-content/$path" | tr '\n' '\\n')
            
            # Make API call (replace with actual Gemini API endpoint)
            response=$(curl -s -X POST "https://api.gemini.com/v1/process" \
              -H "Authorization: Bearer $GEMINI_API_KEY" \
              -H "Content-Type: application/json" \
              -d "{\"input\": \"$p1$content$p2\"}")
            
            # Create directory if it doesn't exist
            mkdir -p "this-repo/$(dirname "$path")"
            
            # Save response
            echo "$response" > "this-repo/$path"
            
            # Wait 2 seconds
            sleep 2
          done

      # Commit and push results
      - name: Commit results
        run: |
          cd this-repo
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add .
          git commit -m "Update processed content"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}