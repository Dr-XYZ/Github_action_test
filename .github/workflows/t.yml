name: Process MDN Content with Gemini API

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  process-content:
    runs-on: ubuntu-latest

    steps:
      # Step 0: Checkout original repository
      - name: Checkout original repository
        uses: actions/checkout@v4
        with:
          path: original-repo

      # Step 1: Checkout mdn/content repository
      - name: Checkout mdn/content
        uses: actions/checkout@v4
        with:
          repository: mdn/content
          path: mdn-content

      # Step 2: Read p1.md and p2.md from original repository
      - name: Read p1 and p2 content
        id: get-content
        run: |
          p1_file="original-repo/p1.md"
          p2_file="original-repo/p2.md"

          if [ -f "$p1_file" ]; then
            p1_content=$(cat "$p1_file")
          else
            p1_content=""
          fi

          if [ -f "$p2_file" ]; then
            p2_content=$(cat "$p2_file")
          else
            p2_content=""
          fi

          # 使用 EOF 避免 shell 解析錯誤
          {
            echo "p1<<EOF"
            echo "$p1_content"
            echo "EOF"
            echo "p2<<EOF"
            echo "$p2_content"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      # Step 3: Read and process README paths from original repo
      - name: Read and process README paths
        id: get-paths
        run: |
          readme_file="original-repo/README.md"
          
          if [ ! -f "$readme_file" ]; then
            echo "Error: README.md not found in original repository"
            exit 1
          fi

          # 處理 README 內容，每一行加上 /index.md
          paths=$(sed 's|$|/index.md|' "$readme_file" | tr '\n' ' ')

          # 使用 EOF 格式輸出，避免 shell 語法錯誤
          {
            echo "paths<<EOF"
            echo "$paths"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      # Step 4: Process with Gemini API and save results in original repo
      - name: Process with Gemini API
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          IFS=' ' read -r -a path_array <<< "${{ steps.get-paths.outputs.paths }}"
          p1="${{ steps.get-content.outputs.p1 }}"
          p2="${{ steps.get-content.outputs.p2 }}"

          for path in "${path_array[@]}"; do
            content=""
            mdn_path="mdn-content/$path"

            # 檢查 mdn-content 是否有對應檔案
            if [ -f "$mdn_path" ]; then
              content=$(cat "$mdn_path")
            fi

            # 呼叫 Gemini API
            response=$(curl -s -X POST "https://api.gemini.com/v1/process" \
              -H "Authorization: Bearer $GEMINI_API_KEY" \
              -H "Content-Type: application/json" \
              -d "{\"input\": \"$p1\n$content\n$p2\"}")

            # 建立目錄並儲存回應
            mkdir -p "original-repo/$(dirname "$path")"
            echo "$response" > "original-repo/$path"

            sleep 2
          done

      # Step 5: Commit and push results to original repository
      - name: Commit results
        run: |
          cd original-repo
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add .
          git commit -m "Update processed content" || echo "No changes to commit"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}