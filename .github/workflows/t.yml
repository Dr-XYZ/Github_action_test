name: Process MDN Files with Gemini 2.0 Flash

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  process-mdn:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Read path list from README.md
        id: read_paths
        run: |
          paths=$(awk 'NF && $1 !~ /^#/' README.md)
          echo "paths<<EOF" >> $GITHUB_ENV
          echo "$paths" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Checkout MDN Content
        uses: actions/checkout@v4
        with:
          repository: mdn/content
          path: mdn_content

      - name: Read Prompt Files
        id: read_prompts
        run: |
          echo "p1=$(cat p1.txt)" >> $GITHUB_ENV
          echo "p2=$(cat p2.txt)" >> $GITHUB_ENV

      - name: Install Google GenAI Client
        run: |
          python -m pip install --upgrade google-genai

      - name: Process and Send to Gemini 2.0 Flash using Python Client
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          import os
          from google import genai

          # Initialize GenAI client
          client = genai.Client(api_key=os.getenv("GEMINI_API_KEY"))
          
          # Read the paths from the environment variable
          paths = os.getenv("paths").splitlines()

          for path in paths:
              mdn_file = f"mdn_content/{path}/index.md"
              output_file = f"{path}/index.md"

              if os.path.exists(mdn_file):
                  with open(mdn_file, "r") as file:
                      content = file.read()

                  prompt = f"{os.getenv('p1')}\n{content}\n{os.getenv('p2')}"
                  print(f"Prompt for {path}/index.md:\n{prompt}")

                  # Send the prompt to the Gemini 2.0 API
                  response = client.models.generate_content(
                      model="gemini-2.0-flash", contents=prompt
                  )

                  extracted_text = response.text

                  if not extracted_text:
                      print(f"No text extracted from API response for {path}/index.md")
                      continue

                  print(f"API Response for {path}/index.md:\n{extracted_text}")

                  # Write the extracted text to the output file
                  os.makedirs(os.path.dirname(output_file), exist_ok=True)
                  with open(output_file, "w") as output:
                      output.write(extracted_text)

                  # Sleep to avoid overloading the API
                  time.sleep(2)
              else:
                  print(f"File {mdn_file} not found, skipping.")
      
      - name: Commit and Push Changes
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add .
          git commit -m "Update processed files from MDN Content with Gemini 2.0 Flash" || true
          git push